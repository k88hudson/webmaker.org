<!DOCTYPE html>
<html>
  <head>
    <title>Persona SSO</title>
    <link rel="stylesheet" href="http://localhost:3000/css/nav.css" />
  </head>
  <body id="webmaker-nav">
    <script src="https://login.persona.org/include.js"></script>
    <script>
      /**
       * factory function for sso_... handling
       */
      function proxyPersona(source, type) {
        return function(arg) {
          var payload = {
            type: type,
            data: {}
          };
          switch (type) {
            case "sso_onlogin":
              payload.data.assertion = arg;
              break;
          }
          source.postMessage(JSON.stringify(payload), "*");
        }
      }

      // ...
      var myOrigin = location.protocol + "//" + location.host;

      /**
       * Listen for messages from owning document.
       */
      window.addEventListener("message", function(event) {
        var payload = JSON.parse(event.data);

        console.log("POSTMESSAGE RECEIVED IN IFRAME: ", payload);

        // what are we instructed to do?
        if (payload.type === "sso_watch") {
          navigator.id.watch({
            loggedInUser: payload.data.loggedInUser,
            onlogin: proxyPersona(event.source, "sso_onlogin"),
            onlogout: proxyPersona(event.source, "sso_onlogout"),
            onmatch: proxyPersona(event.source, "sso_onmatch")
          });
        }
      }, false);
    </script>

    <div class="webmaker-nav-container">
      <nav class="webmaker-nav-container">
        <ul class="webmaker-nav user-info">
          <li>
            <button id="webmaker-login">Sign in to save <span>Sign up</span></button>
            <button id="webmaker-logout" style="display:block!important">Sign out</button>
          </li>
        </ul>
      </nav>
    </div>

  <script>
    // Set up the login button's UX
    var login = document.getElementById("webmaker-login");
    login.addEventListener("click", function() {
      navigator.id.request(/*{
        siteName: document.title
      }*/);
    }, false);

    // Set up the logout button's UX
    var logout = document.getElementById("webmaker-logout");
    logout.addEventListener("click", function() {
      navigator.id.logout();
    }, false);
  </script>

  </body>
</html>
