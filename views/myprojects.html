<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="ext/css/font-awesome.css">
    <link rel="stylesheet" href="/css/myprojects.css">
  </head>
  <body>
    <header>
      <span class="title-text"><span id="username"></span>'s projects</span>
      <!-- TODO <div class="ui-select">Most recent<a class="icon-caret-down"></a></div> -->
      <div data-filter="thimble" class="filter-btn ui-toggle off">thimble</div>
      <div data-filter="popcorn" class="filter-btn ui-toggle off">popcorn</div>
    </header>
    <div id="main">
      <a id="left-btn" class="icon-arrow-left"></a>
      <ul id="projects">

        <li class="project" style="display:none;">
          <a class="project-edit" href="">
            <span class="project-title"></span>
            <span class="project-updated"></span>
            <a class="project-link" target="_blank" href="">view</a>
            <a class="project-link" target="_blank" href="">edit</a>
          </a>
        </li>

      </ul>
      <a id="right-btn" class="icon-arrow-right"></a>
      <script src="{{ makeEndpoint }}/js/make-api.js"></script>
      <script src="ext/js/moment.js"></script>
      <script>
        var make = Make({ apiURL: "{{ makeEndpoint }}" }),
            username = document.getElementById( "username" ),
            projectList = document.getElementById( "projects" ),
            projectTemplate = document.querySelector( ".project" ),
            filterBtns = document.querySelectorAll( ".filter-btn" ),
            email,
            appContext;

        function getParameterByName( name ) {
            name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        projectTemplate.parentNode.removeChild( projectTemplate );

        function createProject( data ) {
          var el = projectTemplate.cloneNode( true );
          el.style.display = "";
          el.classList.add( data.type + "-project" );
          el.querySelector( ".project-title" ).innerHTML = data.title;
          el.querySelector( ".project-updated" ).innerHTML = data.updated;
          el.querySelector( ".project-edit" ).href = data.edit;

          projectList.appendChild( el );
        }


        email = getParameterByName( "email" );
        appContext = getParameterByName( "app" );

        if ( !email ) {
          return;
        }
        function getMakes( filter ) {
          make.email( email )
          .limit( 30 )
          .sortByField( "updatedAt", "desc" )
          .then( function ( err, results ) {
            var type,
                url;
            if ( results && results.hits ) {
              projectList.innerHTML = "";
              for ( var i = 0; i < results.hits.length; i++ ) {
                type = results.hits[ i ].contentType;
                if ( !type ) {
                  continue;
                }
                type = type.split( "application/x-" );
                if ( !type[ 1 ] ) {
                  continue;
                }
                type = type[ 1 ];
                url = results.hits[ i ].url;
                if ( type === filter ) {
                  createProject({
                    title: results.hits[ i ].title || url,
                    edit: url + "/edit",
                    type: type,
                    view: url,
                    thumbnail: results.hits[ i ].thumbnail || "",
                    updated: moment( results.hits[ i ].updatedAt ).fromNow()
                  });
                }
              }
            }
          });
        }

        getMakes( appContext );
        document.querySelector( "[data-filter=" + appContext +  "]" ).classList.add( "on" );
        username.innerHTML = email;

        for ( var i = 0; i < filterBtns.length; i++ ) {
          filterBtns[ i ].addEventListener( "click", function( e ) {
            var filterParam = this.getAttribute( "data-filter" );

            getMakes( filterParam );
            for ( var j = 0; j < filterBtns.length; j++ ) {
              filterBtns[ j ].classList.remove( "on" );
              filterBtns[ j ].classList.add( "off" );
            }
            this.classList.remove( "off" );
            this.classList.add( "on" );
          }, false );
        }

      </script>
    </div>
  </body>
</html>
