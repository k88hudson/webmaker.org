<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="ext/css/font-awesome.css">
    <link rel="stylesheet" href="/css/myprojects.css">
  </head>
  <body>
    <header>
      <span class="title-text"><span id="username"></span>'s recent projects</span>
      <!-- TODO <div class="ui-select">Most recent<a class="icon-caret-down"></a></div> -->
      <div data-filter="thimble" class="filter-btn ui-toggle off">thimble</div>
      <div data-filter="popcorn" class="filter-btn ui-toggle off">popcorn</div>
    </header>
    <div id="main">
      <div class="projects-container">
        <a id="left-btn" class="icon-arrow-left"></a>
        <ul id="projects">
          <li class="project" style="display:none;">
            <a class="project-edit" href="">
              <span class="project-title"></span>
              <span class="project-updated"></span>
              <a class="project-link" target="_blank" href="">view</a>
              <a class="project-link" target="_blank" href="">edit</a>
            </a>
          </li>
        </ul>
        <a id="right-btn" class="icon-arrow-right"></a>
      </div>
    </div>
      <script src="{{ makeEndpoint }}/js/make-api.js"></script>
      <script src="ext/js/moment.js"></script>
      <script>
        var make = Make({ apiURL: "{{ makeEndpoint }}" }),
            username = document.getElementById( "username" ),
            projectList = document.getElementById( "projects" ),
            projectTemplate = document.querySelector( ".project" ),
            filters = {
              popcorn: false,
              thimble: false
            },
            filterBtns = document.querySelectorAll( ".filter-btn" ),
            rightBtn = document.getElementById( "right-btn" ),
            leftBtn = document.getElementById( "left-btn" ),
            email,
            slideIndex = 0,
            appContext,
            page = 0;

        function getParameterByName( name ) {
            name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
            var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
            return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        function createProject( data ) {
          var el = projectTemplate.cloneNode( true );
          el.style.display = "";
          el.classList.add( data.type + "-project" );
          el.querySelector( ".project-title" ).innerHTML = data.title;
          el.querySelector( ".project-updated" ).innerHTML = "Updated " + data.updated;
          el.querySelector( ".project-edit" ).href = data.edit;

          projectList.appendChild( el );
        }

        function getMakes() {
          make.email( email )
          .limit( 30 )
          .sortByField( "updatedAt", "desc" )
          .then( function ( err, results ) {
            var type,
                url;
            console.log( results );
            if ( results && results.hits ) {
              projectList.innerHTML = "";
              slideIndex = 0;
              for ( var i = 0; i < results.hits.length; i++ ) {
                type = results.hits[ i ].contentType;
                if ( !type ) {
                  continue;
                }
                type = type.split( "application/x-" );
                if ( !type[ 1 ] ) {
                  continue;
                }
                type = type[ 1 ];
                url = results.hits[ i ].url;
                if ( !appContext || filters[ type ] ) {
                  createProject({
                    title: results.hits[ i ].title || url,
                    edit: url + "/edit",
                    type: type,
                    view: url,
                    thumbnail: results.hits[ i ].thumbnail || "",
                    updated: moment( results.hits[ i ].updatedAt ).fromNow()
                  });
                }
              }
            }
          });
        }

        function updateFilter( filter, val ) {
          if ( !val ) {
            // Toggle what exists
            val = filters[ filter ] ? "off" : "on";
          }

          if ( val === "on" ) {
            document.querySelector( "[data-filter=" + filter +  "]" ).classList.add( "on" );
            document.querySelector( "[data-filter=" + filter +  "]" ).classList.remove( "off" );
            filters[ filter ] = true;
          }
          else if ( val == "off" ) {
            document.querySelector( "[data-filter=" + filter +  "]" ).classList.add( "off" );
            document.querySelector( "[data-filter=" + filter +  "]" ).classList.remove( "on" );
            filters[ filter ] = false;
          }

        }

        function slide() {
          var projects = document.querySelectorAll( ".project" );
          for ( var i = 0; i < projects.length; i++ ) {
            if ( i < slideIndex ) {
              projects[ i ].style.width = "0";
            } else {
              projects[ i ].style.width = "";
            }
          }
        }

        projectTemplate.parentNode.removeChild( projectTemplate );
        email = getParameterByName( "email" );
        appContext = getParameterByName( "app" ) || "";
        if ( email ) {
          username.innerHTML = email;
        }
        if ( appContext ) {
          updateFilter( appContext, "on" );
        } else {
          updateFilter( "popcorn", "on" );
          updateFilter( "thimble", "on" );
        }
        getMakes();

        for ( var i = 0; i < filterBtns.length; i++ ) {
          filterBtns[ i ].addEventListener( "click", function( e ) {
            var filterParam = this.getAttribute( "data-filter" );
            filters[ filterParam ] = !filters[ filterParam ];
            this.classList.toggle( "off" );
            this.classList.toggle( "on" );
            getMakes();
          }, false );
        }

        leftBtn.addEventListener( "click", function( e ) {
          if ( slideIndex === 0 ) {
            return;
          }
          slideIndex -= 1;
          console.log( slideIndex );
          slide();
        }, false );

        rightBtn.addEventListener( "click", function( e ) {
          slideIndex += 1;
          slide();
        }, false );
      </script>
  </body>
</html>
